name: Release
run-name: Release ${{ github.ref_name }}

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract version from tag
      id: version
      run: |
        TAG=${GITHUB_REF#refs/tags/v}
        # Extract base version (remove prerelease suffixes like -test, -rc1, -beta, etc.)
        BASE_VERSION=$(echo "$TAG" | sed 's/-.*$//')
        
        # Check if this is a prerelease
        if [[ "$TAG" =~ -[a-zA-Z] ]]; then
          IS_PRERELEASE="true"
          echo "ðŸ·ï¸  This is a prerelease tag: $TAG"
        else
          IS_PRERELEASE="false"
          echo "ðŸ·ï¸  This is a stable release tag: $TAG"
        fi
        
        echo "version=$TAG" >> $GITHUB_OUTPUT
        echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "Release version: $TAG (base: $BASE_VERSION)"
    
    - name: Validate version matches VERSION file
      run: |
        FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
        TAG_VERSION="${{ steps.version.outputs.version }}"
        BASE_VERSION="${{ steps.version.outputs.base_version }}"
        IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
        
        echo "VERSION file: $FILE_VERSION"
        echo "Git tag: $TAG_VERSION"
        echo "Base version: $BASE_VERSION"
        echo "Is prerelease: $IS_PRERELEASE"
        
        # For prereleases, compare base version; for stable releases, exact match
        if [ "$IS_PRERELEASE" = "true" ]; then
          if [ "$FILE_VERSION" != "$BASE_VERSION" ]; then
            echo "âŒ Version mismatch for prerelease!"
            echo "   Expected VERSION file to match base version: $BASE_VERSION"
            exit 1
          fi
          echo "âœ… Prerelease version matches: $FILE_VERSION (tag: $TAG_VERSION)"
        else
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "   VERSION file: $FILE_VERSION"
            echo "   Git tag: $TAG_VERSION"
            exit 1
          fi
          echo "âœ… Version matches: $FILE_VERSION"
        fi
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
    
    - name: Terraform Format Check
      run: terraform fmt -check -recursive
    
    - name: Terraform Init and Validate
      run: |
        terraform init -backend=false
        terraform validate
    
    - name: Extract changelog for this version
      id: changelog
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Extract changelog section for this version
        CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d')
        
        # Save to file for GitHub release
        echo "$CHANGELOG" > release_notes.md
        
        # Check if changelog is empty
        if [ ! -s release_notes.md ]; then
          echo "âš ï¸  No changelog entry found for version $VERSION"
          echo "Release version $VERSION" > release_notes.md
        fi
        
        # Debug output
        echo "Release notes for version $VERSION:"
        cat release_notes.md
    
    - name: Create release archive
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        ARCHIVE_NAME="insightfinder-terraform-${VERSION}.tar.gz"
        
        echo "Creating release archive: $ARCHIVE_NAME"
        tar -czf "$ARCHIVE_NAME" \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='*.tfstate*' \
          --exclude='.terraform' \
          --exclude='outputs' \
          --exclude='*.tar.gz' \
          --transform "s,^,insightfinder-terraform-${VERSION}/," \
          *
        
        # Verify archive was created
        ls -lh "$ARCHIVE_NAME"
        echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
      id: archive
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Read changelog content
        CHANGELOG_CONTENT=$(cat release_notes.md)
        
        # Create enhanced release notes
        cat > enhanced_release_notes.md << 'EOF'
        ## ðŸš€ InsightFinder Terraform Module v${{ steps.version.outputs.version }}
        
        ### ðŸ“¦ Installation
        
        Use this module in your Terraform configuration:
        
        ```hcl
        module "insightfinder" {
          source = "git::https://github.com/insightfinder/terraform.git?ref=v${{ steps.version.outputs.version }}"
          
          base_url    = "https://app.insightfinder.com"
          username    = var.username
          password    = var.password
          license_key = var.license_key
          
          project_config = {
            project_name         = "my-project"
            create_if_not_exists = true
            # ... configuration
          }
        }
        ```
        
        ### ðŸ“‹ What's Changed
        
        EOF
        
        # Append changelog content
        cat release_notes.md >> enhanced_release_notes.md
        
        # Add footer
        cat >> enhanced_release_notes.md << 'EOF'
        
        ### ðŸ“š Documentation
        
        - [README](https://github.com/insightfinder/terraform/blob/v${{ steps.version.outputs.version }}/README.md)
        - [CHANGELOG](https://github.com/insightfinder/terraform/blob/v${{ steps.version.outputs.version }}/CHANGELOG.md)
        
        **Full Changelog**: https://github.com/insightfinder/terraform/compare/v1.0.0...v${{ steps.version.outputs.version }}
        EOF
        
        echo "Enhanced release notes created"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: Release ${{ steps.version.outputs.version }}
        body_path: enhanced_release_notes.md
        files: |
          insightfinder-terraform-${{ steps.version.outputs.version }}.tar.gz
        draft: false
        prerelease: ${{ steps.version.outputs.is_prerelease }}
        generate_release_notes: true
        make_latest: ${{ steps.version.outputs.is_prerelease == 'false' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Release Summary
      run: |
        IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
        
        if [ "$IS_PRERELEASE" = "true" ]; then
          echo "## âš ï¸ Prerelease Published Successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âœ… Release Published Successfully" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**Prerelease:** $IS_PRERELEASE" >> $GITHUB_STEP_SUMMARY
        echo "**Archive:** insightfinder-terraform-${{ steps.version.outputs.version }}.tar.gz" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY

