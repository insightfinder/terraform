name: Version Validation

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  validate-version:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for git tags
    
    - name: Validate version consistency
      run: |
        chmod +x ./scripts/validate_version.sh
        ./scripts/validate_version.sh
    
    - name: Check VERSION file format
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "❌ Invalid version format: $VERSION"
          echo "Expected format: X.Y.Z (e.g., 1.0.0)"
          exit 1
        fi
        echo "✅ Version format is valid: $VERSION"
    
    - name: Validate CHANGELOG.md
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        if ! grep -q "\[${VERSION}\]" CHANGELOG.md; then
          echo "⚠️  Warning: Version $VERSION not found in CHANGELOG.md"
          echo "Please update CHANGELOG.md with release notes"
        else
          echo "✅ CHANGELOG.md contains entry for version $VERSION"
        fi
    
    - name: Check for unreleased changes
      run: |
        if grep -q "## \[Unreleased\]" CHANGELOG.md; then
          echo "ℹ️  Unreleased changes found in CHANGELOG.md"
        fi

  terraform-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
    
    - name: Terraform Format Check
      run: terraform fmt -check -recursive
    
    - name: Terraform Init
      run: terraform init -backend=false
    
    - name: Terraform Validate
      run: terraform validate
    
    - name: Check module version output
      timeout-minutes: 2
      run: |
        # Validate that version local is defined
        VERSION=$(echo 'local.module_version' | terraform console)
        echo "Module version: $VERSION"
        if [ -z "$VERSION" ]; then
          echo "❌ Failed to read module version"
          exit 1
        fi
        echo "✅ Module version is accessible: $VERSION"
